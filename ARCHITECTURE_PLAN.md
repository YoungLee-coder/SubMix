# SubMix 架构优化计划（Plan）

> 定位：在线临时工具（不做数据持久化）。
> 
> 目标：在轻量实现前提下，提升可维护性、性能、稳定性与基础安全性。

## 1. 计划概览

### 1.1 当前状态评估

- 项目整体健康，可持续迭代。
- 基础工程能力良好：Next.js App Router + TypeScript strict + 组件化。
- 主要风险集中在：
  - 临时缓存策略未形成明确边界（容量、大小、失效提示）。
  - API 安全基线不足（限流/CORS 白名单/参数约束）。
  - 业务层边界不清晰，逻辑分散。
  - 前端页面未充分利用 RSC，首屏优化空间较大。

### 1.2 目标定义

- 架构目标：职责清晰、模块可演进、易测试。
- 性能目标：降低首屏 JS、优化接口稳定性与响应。
- 工程目标：建立统一错误模型、日志规范、提交门禁。
- 运行目标：适配 Vercel/Cloudflare 等场景下的“临时可用性”。

---

## 2. 优先级问题清单（Backlog）

### P0（必须优先完成）

1. **临时缓存边界未定义**
   - 问题：仅有 TTL，缺少总量上限、单条大小限制、满载淘汰策略。
   - 影响：高峰时可能内存膨胀或服务抖动。
2. **API 缺少安全基线**
   - 问题：开放 CORS `*`、无限流、请求体约束不足。
   - 影响：易被滥用，增加资源与安全风险。

### P1（应在当前迭代完成）

3. **业务逻辑边界不清晰**（hooks / routes / lib 交叉）
4. **API 返回结构不统一**（`error`/`success` 混用）
5. **首页全量 Client 化**（未充分利用 RSC）

### P2（中期优化）

6. `ProxyNode` 含 `[key: string]: any`，类型安全弱。
7. `window.open + document.write` 生成二维码页面，可维护性低。
8. 无测试体系与 pre-commit 门禁，回归风险高。

---

## 3. 执行方案（可落地）

## Phase 1：临时工具稳定性与安全兜底（1-2 天）

### 任务 A：明确“临时缓存”运行边界（保留内存方案）

- 保留 `app/api/subscription/route.ts` 的内存缓存，不引入持久化。
- 新增硬限制：
  - `MAX_CACHE_ITEMS`（如 500）
  - `MAX_CONFIG_BYTES`（如 256KB）
  - 保持 TTL（30 分钟）
- 增加满载淘汰策略（FIFO/LRU 二选一，建议 FIFO 先落地）。
- 响应中明确返回 `expiresAt`，前端提示“临时链接可能提前失效”。

**验收标准**
- 超过大小/数量时返回可读错误（413/429/503 之一并统一语义）。
- 服务在高频写入下内存增长可控。
- 文档明确“不保证跨实例/重启可用”。

### 任务 B：建立 API 安全基线

- 增加限流：按 IP + 路由维度。
- CORS 改为环境变量白名单（开发环境可放宽）。
- 对请求体加入大小限制和 schema 校验（zod）。

**验收标准**
- 高频请求触发 429。
- 非白名单来源跨域请求被拒绝。
- 非法 payload 返回统一 400 错误结构。

---

## Phase 2：架构清晰化与一致性（2-3 天）

### 任务 C：统一 API 响应和错误模型

- 新增：
  - `lib/http/response.ts`
  - `lib/http/errors.ts`
- 统一响应格式：
  - 成功：`{ success: true, data }`
  - 失败：`{ success: false, error: { code, message } }`

**验收标准**
- `app/api/**/route.ts` 全部采用统一返回结构。
- 前端调用层无需对每个接口写特判分支。

### 任务 D：抽出轻量应用服务层（避免过度设计）

- 在 `features/proxy/application` 增加：
  - `parse-links.ts`
  - `generate-config.ts`
  - `publish-subscription.ts`
- Hook 与 API 路由复用同一套应用服务。
- `publish-subscription.ts` 内部保留内存缓存实现，隔离基础设施细节。

**验收标准**
- 核心流程（解析、生成、发布）单点维护。
- 逻辑重复显著减少。

---

## Phase 3：性能与工程规范（2-3 天）

### 任务 E：首屏与客户端负载优化

- 将 `app/page.tsx` 改为 Server Component 容器。
- 仅将交互强组件保留为 Client Components。
- 纯展示模块服务端渲染。

**验收标准**
- 首屏 JS 体积下降（以 `next build` 输出对比）。
- 页面交互无回归。

### 任务 F：工程门禁与测试最小闭环

- 增加脚本：
  - `typecheck`: `pnpm exec tsc --noEmit`
  - `test`: `vitest`（若引入）
- 引入 `husky + lint-staged`：提交前执行 lint + typecheck。

**验收标准**
- 本地提交自动执行质量检查。
- CI 可稳定复现同样检查流程。

---

## 4. 目录演进方案（当前规模最优）

```text
.
├─ app/
│  ├─ api/
│  │  ├─ sub/route.ts
│  │  ├─ subscription/route.ts
│  │  └─ proxy-config/route.ts
│  ├─ page.tsx
│  └─ layout.tsx
├─ features/
│  └─ proxy/
│     ├─ domain/
│     ├─ application/
│     ├─ infrastructure/
│     └─ ui/
├─ lib/
│  ├─ http/
│  ├─ security/
│  └─ logger/
├─ components/
├─ hooks/
├─ types/
└─ tests/
```

说明：
- 当前阶段不建议引入复杂 DDD 全套分层；只需加 `application` 层即可显著改善职责边界。
- `infrastructure` 中可先放 `in-memory` 实现，未来如有需要再替换为 KV/Redis。

---

## 5. 风险与回滚策略

- 风险 1：缓存上限策略过紧，影响用户体验
  - 方案：将上限参数环境变量化，可快速调优。
- 风险 2：统一响应结构影响前端
  - 方案：先新增适配层，再逐步迁移调用端。
- 风险 3：RSC/Client 重构带来交互回归
  - 方案：按模块拆分提交，每步可独立回滚。

---

## 6. 里程碑与交付物

### M1（本周）

- 完成 Phase 1（临时缓存边界 + 安全基线）
- 交付：
  - 可控的临时缓存行为（上限/TTL/错误提示）
  - 限流/CORS/schema 校验生效

### M2（下周）

- 完成 Phase 2（统一响应 + 应用服务层）
- 交付：
  - 统一错误处理机制
  - 核心业务流程服务化

### M3（后续）

- 完成 Phase 3（性能 + 工程门禁）
- 交付：
  - 首页性能优化结果
  - 提交与 CI 质量闭环

---

## 7. Definition of Done（DoD）

- [ ] 关键 API 在“临时工具预期”下行为一致（允许跨实例不一致）。
- [ ] 所有公开接口具备最小安全保护（限流 + CORS 白名单 + 参数校验）。
- [ ] API 响应结构统一，前端错误处理一致。
- [ ] 核心业务逻辑完成应用层收敛，无明显重复实现。
- [ ] `pnpm lint`、`pnpm exec tsc --noEmit` 可稳定通过。
- [ ] 关键路径（解析 -> 生成 -> 发布）具备基础测试覆盖。
- [ ] 用户可感知到“临时链接有效期与失效预期”。

---

## 8. 三条最关键执行原则

1. 坚持“临时工具”定位：不做持久化，但必须有可控上限与明确预期。
2. 先统一边界与错误模型，再扩展功能。
3. 所有改造以“小步快跑、可回滚”为准则，避免大爆炸重构。
